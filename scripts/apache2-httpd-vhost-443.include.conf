# --
# Copyright (C) 2019-2024 Rother OSS GmbH, https://otobo.io/
# added for OTOBO (http://otobo.io/)
# --

# This configuration is the standard way for running OTOBO
# under Apache with SSL.
# Dynamic and static content is generated by the Plack app otobo.psgi.
# Support for DEFLATE could be added here in future.

# Please change here * to the server IP-address
<VirtualHost *:443>

    # Please change here the otobo admin mail address
    ServerAdmin mail@otobo.io

    # Please change here the FQDN or hostname, you like to use with OTOBO
    ServerName helpdesk.otobo.de

    # Please change here and add more different FQDNÂ´s or hostnames, you like to use with OTOBO
    ServerAlias www.helpdesk.otobo.de

    HostnameLookups Off
    UseCanonicalName Off
    ServerSignature Off

    <IfModule mod_ssl.c>

        # Please load the ssl module before (On most linux systems use: "bash> a2enmod ssl")
        SSLEngine on

        # Please add the path to the ssl cert
        SSLCertificateFile /etc/ssl/certs/otobo.de.cert

        # Please add the path to the ssl key
        SSLCertificateKeyFile /etc/ssl/private/otobo.de.nopass.key

        # Please add the path to the ssl chain file (Download from used ssl cert publisher)
        SSLCertificateChainFile /etc/ssl/certs/linux_intermediate_otobo.ch.pem

    </IfModule>

    # mod_perl is required
    <IfModule !mod_perl.c>
        Error "mod_perl is required for Plack::Handler::Apache. Use apache2-httpd-cgi.include.conf as fallback."
    </IfModule>

    <IfModule mod_perl.c>

        <IfModule mpm_event_module>
            Error "The Multi-Processing Module mpm_event is active but it isn' supported by OTOBO. Please switch to mpm_prefork."
        </IfModule>

        <IfModule mpm_worker_module>
            Error "The Multi-Processing Module mpm_worker is active but it isn't supported by OTOBO. Please switch to mpm_prefork."
        </IfModule>

        # Use a dedicated Perl interpreter for the current virtual host, in this case  the virtual host serving port 443
        PerlOptions +Parent

        # Preload otobo.psgi so that that the app doesn't have to be loaded again for every process.
        # This also sets @INC.
        PerlPostConfigRequire /opt/otobo/scripts/apache2-perl-preload_otobo_psgi.pl

        # everything is handled by the PSGI app
        <Location />

            # handle all requests, including the static content, with otobo.psgi
            SetHandler          perl-script
            PerlResponseHandler Plack::Handler::Apache2
            PerlSetVar          psgi_app /opt/otobo/bin/psgi-bin/otobo.psgi

            # Require is supported starting with Apache 2.4.
            # No authentication and all requests are allowed.
            Require all granted

        </Location>
    </IfModule>

</VirtualHost>

# Limit the number of requests per child to avoid excessive memory usage.
# 1000 is the same value as the default value used by Gazelle.
MaxConnectionsPerChild 1000
