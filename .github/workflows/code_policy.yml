%YAML 1.1
---
name: 'CodePolicy'
#on: ['pull_request']
on: ['push']
jobs:
    CodePolicy:
        runs-on: 'ubuntu-latest'
        env:
            PERL5LIB: local
        steps:
            - id: files
              uses: jitterbit/get-changed-files@v1

            - name: 'install dependencies'
              run: sudo apt install -y libcode-tidyall-perl libnamespace-autoclean-perl libxml2-utils libxml-libxslt-perl cpanminus

            - name: 'checkout otobo'
              uses: actions/checkout@v2

            # some diagnostics
            - name: perl -V
              run: perl -V
            - name: env
              run: printenv | sort

            - name: 'install from cpanfile.docker'
              run: cpanm -l local --quiet --notest --installdeps --cpanfile cpanfile.docker . || sh -xc 'cat ~/.cpanm/work/*/build.log'

            - name: 'tree local'
              run: pwd; tree local

            - name: 'checkout codepolicy'
              uses: actions/checkout@v2
              with:
                repository: RotherOSS/codepolicy
                ref: rel-10_0_4
                path: codepolicy

            - name: 'run CodePolicy'
              run: codepolicy/bin/otobo.CodePolicy.pl -l ${{ steps.files.outputs.added_modified }}

